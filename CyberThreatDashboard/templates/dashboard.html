{% extends "base.html" %}
{% block content %}
<h2 class="mb-4">Threat Monitoring</h2>

<div class="card p-3">
  <h3>Real-time Alerts</h3>
  <div class="table-responsive">
    <table class="table table-dark table-striped">
      <thead>
        <tr><th>IP</th><th>Country</th><th>Abuse Score</th><th>Last Reported</th></tr>
      </thead>
      <tbody id="feed-body">
        {% for inc in incidents %}
        <tr>
          <td>{{ inc.ioc }}</td>
          <td>{{ inc.country }}</td>
          <td>{{ inc.abuseScore }}</td>
          <td>{{ inc.time }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card p-3 mt-3">
  <h3>Trend Analysis</h3>
  <canvas id="lineTrend" height="100"></canvas>
  <canvas id="pieSeverity" height="80" class="mt-3"></canvas>
</div>

<div class="card p-3 mt-3">
  <h3>Recent Incidents</h3>
  <div class="incidents-grid">
    {% for inc in incidents %}
    <div class="incident-card">
      <div class="incident-header">
        <strong>{{ inc.ioc }}</strong>
        <span class="badge {{ inc.severity|lower }}">{{ inc.severity }}</span>
      </div>
      <div class="incident-body mt-2">
        <p>Type: {{ inc.type }} • Country: {{ inc.country }} • Score: {{ inc.abuseScore }}</p>
        <p>Last seen: {{ inc.time }}</p>
        <details>
          <summary>Recommended Actions</summary>
          <ul>
            {% for a in inc.actions %}
            <li>{{ a }}</li>
            {% endfor %}
          </ul>
        </details>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div class="card p-3 mt-3">
  <h3>Top Recommended Actions</h3>
  <ol>
    {% for a in top_actions[:6] %}
      <li>{{ a }}</li>
    {% endfor %}
  </ol>
</div>

<script>
setInterval(function(){
  fetch('{{ url_for("refresh_feed") }}')
    .then(r=>r.json())
    .then(data=>{
      const tbody=document.getElementById('feed-body');
      if(!data || !data.length){ tbody.innerHTML='<tr><td colspan="4" class="text-center">No data</td></tr>'; return; }
      tbody.innerHTML=data.map(d=>`<tr><td>${d.ioc}</td><td>${d.country}</td><td>${d.abuseScore}</td><td>${d.lastReported}</td></tr>`).join('');
  });
},60000);

const counts={{ counts|tojson }};
const trend={{ trend|tojson }};

// Pie chart
const pieCtx=document.getElementById('pieSeverity').getContext('2d');
new Chart(pieCtx,{
  type:'pie',
  data:{labels:['High','Medium','Low'], datasets:[{data:[counts.High||0,counts.Medium||0,counts.Low||0], backgroundColor:['#e15759','#f28e2b','#4e79a7']}]}
});

// Line chart
const times=trend.map(p=>new Date(p.time).toLocaleTimeString());
const highs=trend.map(p=>p.counts.High||0);
const meds=trend.map(p=>p.counts.Medium||0);
const lows=trend.map(p=>p.counts.Low||0);

const lineCtx=document.getElementById('lineTrend').getContext('2d');
new Chart(lineCtx,{
  type:'line',
  data:{labels:times,datasets:[
    {label:'High', data:highs, borderColor:'#e15759', fill:false},
    {label:'Medium', data:meds, borderColor:'#f28e2b', fill:false},
    {label:'Low', data:lows, borderColor:'#4e79a7', fill:false}
  ]},
  options:{animation:{duration:400}}
});
</script>
{% endblock %}
